# Troubleshooting Guide

## Error: "Failed to set C language"

### Problem

When running `./index-c`, you see:
```
ERROR: Failed to set C language
ERROR: Failed to set C language
...
```

This error occurs when there's a version mismatch between the tree-sitter library installed on your system and the tree-sitter grammar parsers that were used to generate the language parsers.

### Diagnosis Commands

#### 1. Check installed tree-sitter library version
```bash
pkg-config --modversion tree-sitter
```
This shows the version of the tree-sitter library your system has installed.

#### 2. Check which library the binary is using
```bash
ldd build/index-c | grep tree-sitter
```
This shows which tree-sitter library file the `index-c` binary is actually linking to at runtime.

#### 3. Check grammar parser version
```bash
head -1 tree-sitter-c/src/parser.c
```
This shows which version of tree-sitter was used to generate the C grammar parser. Look for a comment like:
```c
/* Automatically @generated by tree-sitter v0.25.4 ... */
```

#### 4. Check all grammar versions
```bash
head -1 tree-sitter-typescript/typescript/src/parser.c tree-sitter-go/src/parser.c tree-sitter-php/php/src/parser.c
```
This checks all language parsers to see which tree-sitter version generated them.

#### 5. Verify symbol exists in binary
```bash
nm build/index-c | grep tree_sitter_c
```
This confirms the `tree_sitter_c` function is present in the compiled binary.

### Root Cause

The `ts_parser_set_language()` function performs ABI compatibility checks. When the language version in the grammar parser doesn't match what the tree-sitter library expects, it returns `false`, causing the error.

In our case:
- System had tree-sitter **v0.20.9** installed
- Grammar parsers were generated with tree-sitter **v0.25.4-0.25.8**
- These versions are incompatible

### Solution: Install Tree-Sitter from Source

#### Step 1: Clone and build tree-sitter

```bash
# Clone the repository
cd /tmp
git clone https://github.com/tree-sitter/tree-sitter.git
cd tree-sitter

# Check available versions
git tag | grep "^v0\.2[56]" | sort -V | tail -5

# Checkout the desired version (use latest stable, e.g., v0.25.10)
git checkout v0.25.10

# Build the library
make
```

#### Step 2: Install tree-sitter library

```bash
# Install to /usr/local (requires sudo)
sudo make install

# Update library cache so system knows about new library
sudo ldconfig
```

#### Step 3: Configure system to prefer /usr/local/lib

```bash
# Add /usr/local/lib to library search path
echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/local.conf

# Update cache again
sudo ldconfig
```

#### Step 4: Update Makefile

Edit the Makefile to ensure Linux builds use the new library location. Change the Linux section to:

```makefile
else
    # Linux paths
    INCLUDE_PATHS = -I/usr/local/include -I/usr/include -I. -I$(TS_GRAMMAR_DIR)/src -I$(C_GRAMMAR_DIR)/src -I$(PHP_GRAMMAR_DIR)/src -I$(GO_GRAMMAR_DIR)/src
    LIB_PATHS = -L/usr/local/lib -Wl,-rpath,/usr/local/lib
endif
```

The `-L/usr/local/lib` tells the linker where to find libraries at link time.
The `-Wl,-rpath,/usr/local/lib` embeds the library path in the binary so it knows where to find libraries at runtime.

#### Step 5: Rebuild indexers

```bash
# Clean old build artifacts
make clean

# Rebuild everything
make
```

#### Step 6: Verify the fix

```bash
# Check that binary now links to new library
ldd build/index-c | grep tree-sitter
# Should show: libtree-sitter.so.0.25 => /usr/local/lib/libtree-sitter.so.0.25

# Test indexing
rm -f code-index.db
./index-c ./scratch/sources/c --once

# Should see successful output like:
# Indexed ./scratch/sources/c/test.c: 6 entries
# ...
```

### Why Each Step is Necessary

1. **Clone from source**: System package managers often have outdated versions of tree-sitter. Building from source ensures you get the version you need.

2. **Install to /usr/local**: This is the standard location for locally compiled software, separate from system packages.

3. **Update ldconfig**: The dynamic linker cache needs to be updated when new libraries are installed, otherwise programs won't find them.

4. **Configure /etc/ld.so.conf.d**: Ensures /usr/local/lib is in the library search path system-wide.

5. **Update Makefile with -rpath**: Without rpath, binaries may find the old library in /lib or /usr/lib even if the new one exists. The rpath embeds the correct library path directly in the binary.

6. **Rebuild**: Old binaries have the library path and version expectations from when they were compiled. They must be rebuilt to use the new library.

### Alternative: Set LD_LIBRARY_PATH (Temporary)

If you don't want to modify system configuration, you can use:
```bash
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
./index-c ./scratch/sources/c --once
```

However, this is temporary and only lasts for the current shell session. The rpath method is preferred for permanent installation.
