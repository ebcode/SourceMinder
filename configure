#!/bin/bash
# Configuration script for indexer-c

# Default values - all languages disabled by default
ENABLE_TS=0
ENABLE_C=0
ENABLE_PHP=0
ENABLE_GO=0
ENABLE_PYTHON=0
CC="${CC:-gcc}"

# Detect OS for platform-specific commands
UNAME_S=$(uname -s)
if [ "$UNAME_S" = "Darwin" ]; then
    # macOS requires empty string after -i
    SED_INPLACE="sed -i ''"
else
    # Linux uses -i directly
    SED_INPLACE="sed -i"
fi

# Parse command line arguments
show_help() {
    cat << EOF
Usage: ./configure [OPTIONS]

Language Options (all disabled by default):
  --enable-all         Enable all languages
  --enable-typescript  Enable TypeScript indexer
  --enable-c           Enable C indexer
  --enable-php         Enable PHP indexer
  --enable-go          Enable Go indexer
  --enable-python      Enable Python indexer
  --disable-typescript Disable TypeScript indexer
  --disable-c          Disable C indexer
  --disable-php        Disable PHP indexer
  --disable-go         Disable Go indexer
  --disable-python     Disable Python indexer

Other Options:
  --help               Show this help message
  CC=compiler          Specify C compiler (default: gcc)

Examples:
  ./configure --enable-c                          # C-only build
  ./configure --enable-c --enable-typescript      # C + TypeScript
  ./configure --enable-all                        # All languages
  ./configure --enable-all --disable-go           # All except Go
  CC=clang ./configure --enable-c                 # C-only with clang

EOF
    exit 0
}

while [ $# -gt 0 ]; do
    case "$1" in
        --enable-all)
            ENABLE_TS=1
            ENABLE_C=1
            ENABLE_PHP=1
            ENABLE_GO=1
            ENABLE_PYTHON=1
            ;;
        --enable-typescript)
            ENABLE_TS=1
            ;;
        --disable-typescript)
            ENABLE_TS=0
            ;;
        --enable-c)
            ENABLE_C=1
            ;;
        --disable-c)
            ENABLE_C=0
            ;;
        --enable-php)
            ENABLE_PHP=1
            ;;
        --disable-php)
            ENABLE_PHP=0
            ;;
        --enable-go)
            ENABLE_GO=1
            ;;
        --disable-go)
            ENABLE_GO=0
            ;;
        --enable-python)
            ENABLE_PYTHON=1
            ;;
        --disable-python)
            ENABLE_PYTHON=0
            ;;
        --help)
            show_help
            ;;
        CC=*)
            CC="${1#CC=}"
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run './configure --help' for usage information"
            exit 1
            ;;
    esac
    shift
done

echo "Configuring indexer-c..."
echo ""

# Check for required tools
if ! command -v "$CC" >/dev/null 2>&1; then
    echo "Error: C compiler '$CC' not found"
    exit 1
fi
echo "  C compiler: $CC"

# Check for tree-sitter
#if echo '#include <tree_sitter/api.h>' | $CC -E - >/dev/null 2>&1 || \
#    echo '#include <tree-sitter/api.h>' | $CC -E - >/dev/null 2>&1; then
#    echo "  tree-sitter: found"
#else
#    echo "Error: tree-sitter development library not found"
#    echo "Install: sudo apt-get install libtree-sitter-dev"
#    exit 1
#fi

# Check for SQLite
#if echo '#include <sqlite3.h>' | $CC -E - >/dev/null 2>&1; then
#    echo "  SQLite: found"
#else
#    echo "Error: SQLite development library not found"
#    echo "Install: sudo apt-get install libsqlite3-dev"
#    exit 1
#fi

# Function to extract version from package.json using grep and sed (cross-platform)
extract_version() {
    local package_json="$1"
    if [ -f "$package_json" ]; then
        # Extract version line, remove quotes, commas, and whitespace
        grep '"version"' "$package_json" | head -1 | sed 's/.*"version"[^"]*"\([^"]*\)".*/\1/'
    else
        echo "unknown"
    fi
}

# Generate grammar_version.h files for enabled languages
echo ""
echo "Generating grammar version headers..."

if [ $ENABLE_TS -eq 1 ]; then
    TS_VERSION=$(extract_version "tree-sitter-typescript/package.json")
    echo "  TypeScript grammar: $TS_VERSION"
    cat > typescript/grammar_version.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef TS_GRAMMAR_VERSION_H
#define TS_GRAMMAR_VERSION_H
#define GRAMMAR_NAME "typescript"
#define GRAMMAR_VERSION "$TS_VERSION"
#endif
EOF
fi

if [ $ENABLE_C -eq 1 ]; then
    C_VERSION=$(extract_version "tree-sitter-c/package.json")
    echo "  C grammar: $C_VERSION"
    cat > c/grammar_version.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef C_GRAMMAR_VERSION_H
#define C_GRAMMAR_VERSION_H
#define GRAMMAR_NAME "c"
#define GRAMMAR_VERSION "$C_VERSION"
#endif
EOF
fi

if [ $ENABLE_PHP -eq 1 ]; then
    PHP_VERSION=$(extract_version "tree-sitter-php/package.json")
    echo "  PHP grammar: $PHP_VERSION"
    cat > php/grammar_version.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef PHP_GRAMMAR_VERSION_H
#define PHP_GRAMMAR_VERSION_H
#define GRAMMAR_NAME "php"
#define GRAMMAR_VERSION "$PHP_VERSION"
#endif
EOF
fi

if [ $ENABLE_GO -eq 1 ]; then
    GO_VERSION=$(extract_version "tree-sitter-go/package.json")
    echo "  Go grammar: $GO_VERSION"
    cat > go/grammar_version.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef GO_GRAMMAR_VERSION_H
#define GO_GRAMMAR_VERSION_H
#define GRAMMAR_NAME "go"
#define GRAMMAR_VERSION "$GO_VERSION"
#endif
EOF
fi

if [ $ENABLE_PYTHON -eq 1 ]; then
    PYTHON_VERSION=$(extract_version "tree-sitter-python/package.json")
    echo "  Python grammar: $PYTHON_VERSION"
    cat > python/grammar_version.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef PYTHON_GRAMMAR_VERSION_H
#define PYTHON_GRAMMAR_VERSION_H
#define GRAMMAR_NAME "python"
#define GRAMMAR_VERSION "$PYTHON_VERSION"
#endif
EOF
fi

# Generate config.h
echo ""
echo "Generating config.h..."
cat > config.h << EOF
/* Generated by ./configure - DO NOT EDIT */
#ifndef CONFIG_H
#define CONFIG_H

/* Language support */
#define ENABLE_TYPESCRIPT $ENABLE_TS
#define ENABLE_C $ENABLE_C
#define ENABLE_PHP $ENABLE_PHP
#define ENABLE_GO $ENABLE_GO
#define ENABLE_PYTHON $ENABLE_PYTHON

/* Convenience macro for checking if a language is enabled */
#define ENABLED(lang) (ENABLE_##lang)

#endif /* CONFIG_H */
EOF

# Prepare language-specific build targets
ALL_TARGETS=""
SYMLINK_TARGETS=""

if [ $ENABLE_TS -eq 1 ]; then
    ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/index-ts"
    SYMLINK_TARGETS="$SYMLINK_TARGETS ./index-ts"
fi

if [ $ENABLE_C -eq 1 ]; then
    ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/index-c"
    SYMLINK_TARGETS="$SYMLINK_TARGETS ./index-c"
fi

if [ $ENABLE_PHP -eq 1 ]; then
    ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/index-php"
    SYMLINK_TARGETS="$SYMLINK_TARGETS ./index-php"
fi

if [ $ENABLE_GO -eq 1 ]; then
    ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/index-go"
    SYMLINK_TARGETS="$SYMLINK_TARGETS ./index-go"
fi

if [ $ENABLE_PYTHON -eq 1 ]; then
    ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/index-python"
    SYMLINK_TARGETS="$SYMLINK_TARGETS ./index-python"
fi

# Always include qi
ALL_TARGETS="$ALL_TARGETS \$(BUILD_DIR)/qi"
SYMLINK_TARGETS="$SYMLINK_TARGETS ./qi"

# Generate Makefile
echo "Generating Makefile..."

cat > Makefile << 'EOF_MAKEFILE'
CC = @CC@

# Detect OS
UNAME_S := $(shell uname -s)

# Tree-sitter grammar directories (reference external repos)
TS_GRAMMAR_DIR = tree-sitter-typescript/typescript
C_GRAMMAR_DIR = tree-sitter-c
PHP_GRAMMAR_DIR = tree-sitter-php/php
GO_GRAMMAR_DIR = tree-sitter-go
PYTHON_GRAMMAR_DIR = tree-sitter-python

# macOS (Homebrew) paths
ifeq ($(UNAME_S),Darwin)
    # Try to detect Homebrew prefix (Apple Silicon vs Intel)
    HOMEBREW_PREFIX := $(shell test -d /opt/homebrew && echo /opt/homebrew || echo /usr/local)
    SQLITE_PREFIX := $(HOMEBREW_PREFIX)/opt/sqlite
    INCLUDE_PATHS = -I$(HOMEBREW_PREFIX)/include -I$(SQLITE_PREFIX)/include -I. -I$(TS_GRAMMAR_DIR)/src -I$(C_GRAMMAR_DIR)/src -I$(PHP_GRAMMAR_DIR)/src -I$(GO_GRAMMAR_DIR)/src -I$(PYTHON_GRAMMAR_DIR)/src
    LIB_PATHS = -L$(HOMEBREW_PREFIX)/lib -L$(SQLITE_PREFIX)/lib
else
    # Linux paths
    INCLUDE_PATHS = -I/usr/local/include -I/usr/include -I. -I$(TS_GRAMMAR_DIR)/src -I$(C_GRAMMAR_DIR)/src -I$(PHP_GRAMMAR_DIR)/src -I$(GO_GRAMMAR_DIR)/src -I$(PYTHON_GRAMMAR_DIR)/src
    LIB_PATHS = -L/usr/local/lib -Wl,-rpath,/usr/local/lib
endif

# Base flags for release and debug
BASE_CFLAGS_RELEASE = -O3 -march=native -mtune=native -funroll-loops -std=c11 -D_POSIX_C_SOURCE=200809L -D_DEFAULT_SOURCE $(INCLUDE_PATHS)
BASE_CFLAGS_DEBUG = -g -O0 -std=c11 -D_POSIX_C_SOURCE=200809L -D_DEFAULT_SOURCE $(INCLUDE_PATHS)

# Default to release build
BASE_CFLAGS = $(BASE_CFLAGS_RELEASE)

LDFLAGS = $(LIB_PATHS) -lsqlite3 -ltree-sitter
LDFLAGS_DEBUG = $(LIB_PATHS) -lsqlite3 -ltree-sitter -rdynamic

# Compiler-specific warning flags for our code (strict)
GCC_WARNINGS = -Wall -Wextra -fprefetch-loop-arrays
CLANG_WARNINGS = -Wall -Wextra -Wpedantic -Wconversion -Wshadow -Wcast-qual -Wno-gnu-zero-variadic-macro-arguments

# Relaxed flags for third-party tree-sitter code (suppress common third-party warnings)
THIRD_PARTY_WARNINGS = -Wno-sign-conversion -Wno-strict-prototypes -Wno-padded -Wno-documentation -Wno-covered-switch-default -Wno-missing-prototypes

# Detect compiler by parsing version string
COMPILER_VERSION := $(shell $(CC) --version 2>/dev/null)
ifneq '' '$(findstring clang,$(COMPILER_VERSION))'
  CFLAGS = $(BASE_CFLAGS) $(CLANG_WARNINGS)
  THIRD_PARTY_CFLAGS = $(BASE_CFLAGS) $(THIRD_PARTY_WARNINGS)
else ifneq '' '$(findstring g++,$(COMPILER_VERSION))'
  CFLAGS = $(BASE_CFLAGS) $(GCC_WARNINGS)
  THIRD_PARTY_CFLAGS = $(BASE_CFLAGS) $(THIRD_PARTY_WARNINGS)
else ifneq '' '$(findstring gcc,$(COMPILER_VERSION))'
  CFLAGS = $(BASE_CFLAGS) $(GCC_WARNINGS)
  THIRD_PARTY_CFLAGS = $(BASE_CFLAGS) $(THIRD_PARTY_WARNINGS)
else
  $(warning Unknown compiler: $(CC))
  CFLAGS = $(BASE_CFLAGS) -Wall
  THIRD_PARTY_CFLAGS = $(BASE_CFLAGS)
endif

# Shared source files
SHARED_SRC = shared/database.c shared/filter.c shared/file_walker.c shared/file_watcher.c shared/validation.c shared/comment_utils.c shared/string_utils.c shared/file_opener.c shared/indexer_main.c shared/extensions.c shared/parse_result.c shared/file_utils.c shared/paths.c shared/toc.c shared/debug.c shared/version.c shared/sql_builder.c
SHARED_OBJ = $(SHARED_SRC:.c=.o)

# TypeScript language files
TS_TREE_SITTER_SRC = $(TS_GRAMMAR_DIR)/src/parser.c $(TS_GRAMMAR_DIR)/src/scanner.c
TS_TREE_SITTER_OBJ = $(TS_TREE_SITTER_SRC:.c=.o)

TS_LANGUAGE_SRC = typescript/ts_language.c
TS_LANGUAGE_OBJ = $(TS_LANGUAGE_SRC:.c=.o)

TS_MAIN_SRC = typescript/index-ts.c
TS_MAIN_OBJ = $(TS_MAIN_SRC:.c=.o)

# C language files
C_TREE_SITTER_SRC = $(C_GRAMMAR_DIR)/src/parser.c
C_TREE_SITTER_OBJ = $(C_TREE_SITTER_SRC:.c=.o)

C_LANGUAGE_SRC = c/c_language.c
C_LANGUAGE_OBJ = $(C_LANGUAGE_SRC:.c=.o)

C_MAIN_SRC = c/index-c.c
C_MAIN_OBJ = $(C_MAIN_SRC:.c=.o)

# PHP language files
PHP_TREE_SITTER_SRC = $(PHP_GRAMMAR_DIR)/src/parser.c $(PHP_GRAMMAR_DIR)/src/scanner.c
PHP_TREE_SITTER_OBJ = $(PHP_TREE_SITTER_SRC:.c=.o)

PHP_LANGUAGE_SRC = php/php_language.c
PHP_LANGUAGE_OBJ = $(PHP_LANGUAGE_SRC:.c=.o)

PHP_MAIN_SRC = php/index-php.c
PHP_MAIN_OBJ = $(PHP_MAIN_SRC:.c=.o)

# Go language files
GO_TREE_SITTER_SRC = $(GO_GRAMMAR_DIR)/src/parser.c
GO_TREE_SITTER_OBJ = $(GO_TREE_SITTER_SRC:.c=.o)

GO_LANGUAGE_SRC = go/go_language.c
GO_LANGUAGE_OBJ = $(GO_LANGUAGE_SRC:.c=.o)

GO_MAIN_SRC = go/index-go.c
GO_MAIN_OBJ = $(GO_MAIN_SRC:.c=.o)

# Python language files
PYTHON_TREE_SITTER_SRC = $(PYTHON_GRAMMAR_DIR)/src/parser.c $(PYTHON_GRAMMAR_DIR)/src/scanner.c
PYTHON_TREE_SITTER_OBJ = $(PYTHON_TREE_SITTER_SRC:.c=.o)

PYTHON_LANGUAGE_SRC = python/python_language.c
PYTHON_LANGUAGE_OBJ = $(PYTHON_LANGUAGE_SRC:.c=.o)

PYTHON_MAIN_SRC = python/index-python.c
PYTHON_MAIN_OBJ = $(PYTHON_MAIN_SRC:.c=.o)

# Query index
QUERY_SRC = query-index.c
QUERY_OBJ = $(QUERY_SRC:.c=.o)

# Build directory
BUILD_DIR = build

# Targets - configured by ./configure script
all: $(BUILD_DIR)@ALL_TARGETS@@SYMLINK_TARGETS@

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# TypeScript indexer
$(BUILD_DIR)/index-ts: $(SHARED_OBJ) $(TS_TREE_SITTER_OBJ) $(TS_LANGUAGE_OBJ) $(TS_MAIN_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# C indexer
$(BUILD_DIR)/index-c: $(SHARED_OBJ) $(C_TREE_SITTER_OBJ) $(C_LANGUAGE_OBJ) $(C_MAIN_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# PHP indexer
$(BUILD_DIR)/index-php: $(SHARED_OBJ) $(PHP_TREE_SITTER_OBJ) $(PHP_LANGUAGE_OBJ) $(PHP_MAIN_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# Go indexer
$(BUILD_DIR)/index-go: $(SHARED_OBJ) $(GO_TREE_SITTER_OBJ) $(GO_LANGUAGE_OBJ) $(GO_MAIN_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# Python indexer
$(BUILD_DIR)/index-python: $(SHARED_OBJ) $(PYTHON_TREE_SITTER_OBJ) $(PYTHON_LANGUAGE_OBJ) $(PYTHON_MAIN_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# Query tool
$(BUILD_DIR)/qi: $(SHARED_OBJ) $(QUERY_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# Convenience symlinks in root
./index-ts: $(BUILD_DIR)/index-ts
	ln -sf $(BUILD_DIR)/index-ts index-ts

./index-c: $(BUILD_DIR)/index-c
	ln -sf $(BUILD_DIR)/index-c index-c

./index-php: $(BUILD_DIR)/index-php
	ln -sf $(BUILD_DIR)/index-php index-php

./index-go: $(BUILD_DIR)/index-go
	ln -sf $(BUILD_DIR)/index-go index-go

./index-python: $(BUILD_DIR)/index-python
	ln -sf $(BUILD_DIR)/index-python index-python

./qi: $(BUILD_DIR)/qi
	ln -sf $(BUILD_DIR)/qi qi

# Pattern rules for object files
# Third-party tree-sitter parser code (relaxed warnings)
$(TS_GRAMMAR_DIR)/src/%.o: $(TS_GRAMMAR_DIR)/src/%.c
	$(CC) $(THIRD_PARTY_CFLAGS) -c $< -o $@

$(C_GRAMMAR_DIR)/src/%.o: $(C_GRAMMAR_DIR)/src/%.c
	$(CC) $(THIRD_PARTY_CFLAGS) -c $< -o $@

$(PHP_GRAMMAR_DIR)/src/%.o: $(PHP_GRAMMAR_DIR)/src/%.c
	$(CC) $(THIRD_PARTY_CFLAGS) -c $< -o $@

$(GO_GRAMMAR_DIR)/src/%.o: $(GO_GRAMMAR_DIR)/src/%.c
	$(CC) $(THIRD_PARTY_CFLAGS) -c $< -o $@

$(PYTHON_GRAMMAR_DIR)/src/%.o: $(PYTHON_GRAMMAR_DIR)/src/%.c
	$(CC) $(THIRD_PARTY_CFLAGS) -c $< -o $@

# Our code (strict warnings)
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	rm -f $(SHARED_OBJ) $(TS_TREE_SITTER_OBJ) $(TS_LANGUAGE_OBJ) $(TS_MAIN_OBJ) $(C_TREE_SITTER_OBJ) $(C_LANGUAGE_OBJ) $(C_MAIN_OBJ) $(PHP_TREE_SITTER_OBJ) $(PHP_LANGUAGE_OBJ) $(PHP_MAIN_OBJ) $(GO_TREE_SITTER_OBJ) $(GO_LANGUAGE_OBJ) $(GO_MAIN_OBJ) $(PYTHON_TREE_SITTER_OBJ) $(PYTHON_LANGUAGE_OBJ) $(PYTHON_MAIN_OBJ) $(QUERY_OBJ)
	rm -rf $(BUILD_DIR)
	rm -f index-ts index-c index-php index-go index-python qi

install: all install-data
	@mkdir -p /usr/local/bin
	cp $(BUILD_DIR)/qi /usr/local/bin/qi
@INSTALL_TARGETS@

# IMPORTANT: blank line above is required to prevent sed from appending next line to last cp command
	@echo ""
	@echo "Binaries installed to /usr/local/bin/"
	@echo "Data files installed to:"
ifeq ($(UNAME_S),Darwin)
	@echo "  /usr/local/share/indexer-c/"
else
	@echo "  /usr/share/indexer-c/"
endif

# Install config files to system location
install-data:
ifeq ($(UNAME_S),Darwin)
	@echo "Installing config files to /usr/local/share/indexer-c/..."
	mkdir -p /usr/local/share/indexer-c/shared/config
	cp shared/config/*.txt /usr/local/share/indexer-c/shared/config/
@INSTALL_DATA_MAC_TARGETS@

# IMPORTANT: blank line above is required to prevent sed from appending 'else' to last cp command
else
	@echo "Installing config files to /usr/share/indexer-c/..."
	mkdir -p /usr/share/indexer-c/shared/config
	cp shared/config/*.txt /usr/share/indexer-c/shared/config/
@INSTALL_DATA_LINUX_TARGETS@

# IMPORTANT: blank line above is required to prevent sed from appending 'endif' to last cp command
endif

# Uninstall binaries and data files
uninstall:
	rm -f /usr/local/bin/qi
@UNINSTALL_TARGETS@

# IMPORTANT: blank line above is required to prevent sed from appending 'ifeq' to last rm command
ifeq ($(UNAME_S),Darwin)
	rm -rf /usr/local/share/indexer-c
	@echo "Uninstalled from /usr/local/bin/ and /usr/local/share/indexer-c/"
else
	rm -rf /usr/share/indexer-c
	@echo "Uninstalled from /usr/local/bin/ and /usr/share/indexer-c/"
endif

lint:
	@echo "Running clang-tidy..."
	@clang-tidy shared/*.c typescript/*.c typescript/src/*.c query-index.c \
		-- $(CFLAGS) -I. -Ishared || true
	@echo ""

# Debug build - rebuild everything with debug symbols
debug:
	@echo "Building with debug symbols (-g -O0 -rdynamic)..."
	$(MAKE) clean
	$(MAKE) all BASE_CFLAGS="$(BASE_CFLAGS_DEBUG)" LDFLAGS="$(LDFLAGS_DEBUG)"

# Test target - compile and run regression tests
test: tests/run-tests
	@echo "Running regression tests..."
	@./tests/run-tests

tests/run-tests: tests/run-tests.c
	@echo "Compiling test runner..."
	@$(CC) -std=c11 -Wall -Wextra -o tests/run-tests tests/run-tests.c

.PHONY: all clean install install-data uninstall lint debug test
EOF_MAKEFILE

# Substitute variables in Makefile
if [ "$UNAME_S" = "Darwin" ]; then
    sed -i '' "s|@CC@|$CC|g" Makefile
    sed -i '' "s|@ALL_TARGETS@|$ALL_TARGETS|g" Makefile
    sed -i '' "s|@SYMLINK_TARGETS@|$SYMLINK_TARGETS|g" Makefile
else
    sed -i "s|@CC@|$CC|g" Makefile
    sed -i "s|@ALL_TARGETS@|$ALL_TARGETS|g" Makefile
    sed -i "s|@SYMLINK_TARGETS@|$SYMLINK_TARGETS|g" Makefile
fi

# Build install/uninstall targets based on enabled languages
INSTALL_TARGETS=""
UNINSTALL_TARGETS=""
INSTALL_DATA_MAC=""
INSTALL_DATA_LINUX=""

if [ $ENABLE_TS -eq 1 ]; then
    INSTALL_TARGETS="$INSTALL_TARGETS\n\tcp \$(BUILD_DIR)/index-ts /usr/local/bin/index-ts"
    UNINSTALL_TARGETS="$UNINSTALL_TARGETS\n\trm -f /usr/local/bin/index-ts"
    INSTALL_DATA_MAC="$INSTALL_DATA_MAC\n\tmkdir -p /usr/local/share/indexer-c/typescript/config\n\tcp typescript/config/*.txt /usr/local/share/indexer-c/typescript/config/"
    INSTALL_DATA_LINUX="$INSTALL_DATA_LINUX\n\tmkdir -p /usr/share/indexer-c/typescript/config\n\tcp typescript/config/*.txt /usr/share/indexer-c/typescript/config/"
fi

if [ $ENABLE_C -eq 1 ]; then
    INSTALL_TARGETS="$INSTALL_TARGETS\n\tcp \$(BUILD_DIR)/index-c /usr/local/bin/index-c"
    UNINSTALL_TARGETS="$UNINSTALL_TARGETS\n\trm -f /usr/local/bin/index-c"
    INSTALL_DATA_MAC="$INSTALL_DATA_MAC\n\tmkdir -p /usr/local/share/indexer-c/c/config\n\tcp c/config/*.txt /usr/local/share/indexer-c/c/config/"
    INSTALL_DATA_LINUX="$INSTALL_DATA_LINUX\n\tmkdir -p /usr/share/indexer-c/c/config\n\tcp c/config/*.txt /usr/share/indexer-c/c/config/"
fi

if [ $ENABLE_PHP -eq 1 ]; then
    INSTALL_TARGETS="$INSTALL_TARGETS\n\tcp \$(BUILD_DIR)/index-php /usr/local/bin/index-php"
    UNINSTALL_TARGETS="$UNINSTALL_TARGETS\n\trm -f /usr/local/bin/index-php"
    INSTALL_DATA_MAC="$INSTALL_DATA_MAC\n\tmkdir -p /usr/local/share/indexer-c/php/config\n\tcp php/config/*.txt /usr/local/share/indexer-c/php/config/"
    INSTALL_DATA_LINUX="$INSTALL_DATA_LINUX\n\tmkdir -p /usr/share/indexer-c/php/config\n\tcp php/config/*.txt /usr/share/indexer-c/php/config/"
fi

if [ $ENABLE_GO -eq 1 ]; then
    INSTALL_TARGETS="$INSTALL_TARGETS\n\tcp \$(BUILD_DIR)/index-go /usr/local/bin/index-go"
    UNINSTALL_TARGETS="$UNINSTALL_TARGETS\n\trm -f /usr/local/bin/index-go"
    INSTALL_DATA_MAC="$INSTALL_DATA_MAC\n\tmkdir -p /usr/local/share/indexer-c/go/config\n\tcp go/config/*.txt /usr/local/share/indexer-c/go/config/"
    INSTALL_DATA_LINUX="$INSTALL_DATA_LINUX\n\tmkdir -p /usr/share/indexer-c/go/config\n\tcp go/config/*.txt /usr/share/indexer-c/go/config/"
fi

if [ $ENABLE_PYTHON -eq 1 ]; then
    INSTALL_TARGETS="$INSTALL_TARGETS\n\tcp \$(BUILD_DIR)/index-python /usr/local/bin/index-python"
    UNINSTALL_TARGETS="$UNINSTALL_TARGETS\n\trm -f /usr/local/bin/index-python"
    INSTALL_DATA_MAC="$INSTALL_DATA_MAC\n\tmkdir -p /usr/local/share/indexer-c/python/config\n\tcp python/config/*.txt /usr/local/share/indexer-c/python/config/"
    INSTALL_DATA_LINUX="$INSTALL_DATA_LINUX\n\tmkdir -p /usr/share/indexer-c/python/config\n\tcp python/config/*.txt /usr/share/indexer-c/python/config/"
fi

# Use printf to handle newlines correctly
if [ "$UNAME_S" = "Darwin" ]; then
    printf "%b" "$INSTALL_TARGETS" | sed -i '' "/^@INSTALL_TARGETS@/r /dev/stdin" Makefile
    sed -i '' "s|@INSTALL_TARGETS@||g" Makefile

    printf "%b" "$UNINSTALL_TARGETS" | sed -i '' "/^@UNINSTALL_TARGETS@/r /dev/stdin" Makefile
    sed -i '' "s|@UNINSTALL_TARGETS@||g" Makefile

    printf "%b" "$INSTALL_DATA_MAC" | sed -i '' "/^@INSTALL_DATA_MAC_TARGETS@/r /dev/stdin" Makefile
    sed -i '' "s|@INSTALL_DATA_MAC_TARGETS@||g" Makefile

    printf "%b" "$INSTALL_DATA_LINUX" | sed -i '' "/^@INSTALL_DATA_LINUX_TARGETS@/r /dev/stdin" Makefile
    sed -i '' "s|@INSTALL_DATA_LINUX_TARGETS@||g" Makefile
else
    printf "%b" "$INSTALL_TARGETS" | sed -i "/^@INSTALL_TARGETS@/r /dev/stdin" Makefile
    sed -i "s|@INSTALL_TARGETS@||g" Makefile

    printf "%b" "$UNINSTALL_TARGETS" | sed -i "/^@UNINSTALL_TARGETS@/r /dev/stdin" Makefile
    sed -i "s|@UNINSTALL_TARGETS@||g" Makefile

    printf "%b" "$INSTALL_DATA_MAC" | sed -i "/^@INSTALL_DATA_MAC_TARGETS@/r /dev/stdin" Makefile
    sed -i "s|@INSTALL_DATA_MAC_TARGETS@||g" Makefile

    printf "%b" "$INSTALL_DATA_LINUX" | sed -i "/^@INSTALL_DATA_LINUX_TARGETS@/r /dev/stdin" Makefile
    sed -i "s|@INSTALL_DATA_LINUX_TARGETS@||g" Makefile
fi

echo ""
echo "Configuration complete!"
echo ""
echo "Build configuration:"
echo "  C compiler: $CC"
echo "  Languages enabled:"
[ $ENABLE_TS -eq 1 ] && echo "    - TypeScript"
[ $ENABLE_C -eq 1 ] && echo "    - C"
[ $ENABLE_PHP -eq 1 ] && echo "    - PHP"
[ $ENABLE_GO -eq 1 ] && echo "    - Go"
[ $ENABLE_PYTHON -eq 1 ] && echo "    - Python"
echo ""
echo "Run 'make' to build the project."
